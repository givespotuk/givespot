<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - GiveSpot</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="../index.html" class="logo-link">
                        <span class="logo-icon">‚ù§Ô∏è</span>
                        <h1 class="logo-text">GiveSpot Admin</h1>
                    </a>
                </div>
                <nav class="nav">
                    <a href="../browse.html" class="nav-link">View Marketplace</a>
                    <button id="adminLogout" class="nav-link btn-outline">Logout</button>
                </nav>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <div class="admin-section">
                <!-- Admin Header -->
                <div class="admin-header">
                    <h2>Platform Administration</h2>
                    <p>Manage charities and monitor platform activity</p>
                </div>

                <!-- Platform Stats -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">üè™</div>
                        <div class="stat-content">
                            <h3>Total Charities</h3>
                            <p id="totalCharities" class="stat-value">Loading...</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-content">
                            <h3>Total Items</h3>
                            <p id="totalItems" class="stat-value">Loading...</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-content">
                            <h3>Pending Applications</h3>
                            <p id="pendingApplications" class="stat-value">Loading...</p>
                        </div>
                    </div>

                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-content">
                            <h3>Monthly Revenue</h3>
                            <p id="monthlyRevenue" class="stat-value">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- Pending Applications -->
                <div class="admin-section-content">
                    <div class="section-header">
                        <h3>Pending Charity Applications</h3>
                        <button onclick="refreshApplications()" class="btn-secondary">Refresh</button>
                    </div>
                    
                    <div id="pendingApplicationsList" class="applications-list">
                        <div class="loading-placeholder">
                            <p>Loading pending applications...</p>
                        </div>
                    </div>
                </div>

                <!-- Active Charities -->
                <div class="admin-section-content">
                    <div class="section-header">
                        <h3>Active Charities</h3>
                        <span class="section-subtitle">Approved charities currently using the platform</span>
                    </div>
                    
                    <div id="activeCharitiesList" class="charities-list">
                        <div class="loading-placeholder">
                            <p>Loading active charities...</p>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="admin-section-content">
                    <div class="section-header">
                        <h3>Recent Platform Activity</h3>
                        <span class="section-subtitle">Latest items and reservations</span>
                    </div>
                    
                    <div id="recentActivity" class="activity-list">
                        <div class="loading-placeholder">
                            <p>Loading recent activity...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">
                    <span class="logo-icon">‚ù§Ô∏è</span>
                    <span class="logo-text">GiveSpot</span>
                </div>
                <p class="footer-text">
                    Admin Dashboard - Platform Management
                </p>
            </div>
        </div>
    </footer>

    <!-- JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/config.js"></script>
    <script src="../js/main.js"></script>
    
    <script>
        // Admin functionality
        let adminUser = null;

        // Load admin dashboard
        async function loadAdminDashboard() {
            try {
                showLoading('Loading admin dashboard...');

                // Load platform statistics
                const [charitiesResult, itemsResult, pendingResult] = await Promise.all([
                    supabase.from('charities').select('*'),
                    supabase.from('items').select('*'),
                    supabase.from('charities').select('*').eq('status', 'pending')
                ]);

                const totalCharities = charitiesResult.data?.length || 0;
                const totalItems = itemsResult.data?.length || 0;
                const pendingCount = pendingResult.data?.length || 0;

                // Update stats
                document.getElementById('totalCharities').textContent = totalCharities;
                document.getElementById('totalItems').textContent = totalItems;
                document.getElementById('pendingApplications').textContent = pendingCount;
                document.getElementById('monthlyRevenue').textContent = '¬£' + (totalItems * 0.10).toFixed(2);

                // Load specific sections
                await loadPendingApplications();
                await loadActiveCharities();
                await loadRecentActivity();

                hideLoading();

            } catch (err) {
                console.error('Admin dashboard error:', err);
                showError('Failed to load admin dashboard: ' + err.message);
                hideLoading();
            }
        }

        // Load pending applications
        async function loadPendingApplications() {
            try {
                const { data: applications, error } = await supabase
                    .from('charities')
                    .select('*')
                    .eq('status', 'pending')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayPendingApplications(applications || []);

            } catch (err) {
                console.error('Error loading applications:', err);
                showError('Failed to load applications');
            }
        }

        // Display pending applications
        function displayPendingApplications(applications) {
            const container = document.getElementById('pendingApplicationsList');

            if (applications.length === 0) {
                container.innerHTML = `
                    <div class="no-items">
                        <p>No pending applications</p>
                    </div>
                `;
                return;
            }

            let html = '';
            applications.forEach(app => {
                html += `
                    <div class="application-card">
                        <div class="application-header">
                            <h4>${app.name}</h4>
                            <span class="application-date">${formatDate(app.created_at)}</span>
                        </div>
                        <div class="application-details">
                            <p><strong>Email:</strong> ${app.email}</p>
                            <p><strong>Postcode:</strong> ${app.postcode}</p>
                            <p><strong>Registration:</strong> ${app.registration_number || 'Not provided'}</p>
                            <p><strong>Contact:</strong> ${app.contact_person || 'Not provided'}</p>
                        </div>
                        <div class="application-actions">
                            <button onclick="approveCharity('${app.id}')" class="btn-success">
                                ‚úÖ Approve
                            </button>
                            <button onclick="rejectCharity('${app.id}')" class="btn-warning">
                                ‚ùå Reject
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Load active charities
        async function loadActiveCharities() {
            try {
                const { data: charities, error } = await supabase
                    .from('charities')
                    .select('*, items(count)')
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                displayActiveCharities(charities || []);

            } catch (err) {
                console.error('Error loading charities:', err);
            }
        }

        // Display active charities
        function displayActiveCharities(charities) {
            const container = document.getElementById('activeCharitiesList');

            if (charities.length === 0) {
                container.innerHTML = `
                    <div class="no-items">
                        <p>No active charities</p>
                    </div>
                `;
                return;
            }

            let html = '<div class="charities-table">';
            charities.forEach(charity => {
                html += `
                    <div class="charity-row">
                        <div class="charity-info">
                            <h4>${charity.name}</h4>
                            <p>${charity.email} ‚Ä¢ ${charity.postcode}</p>
                        </div>
                        <div class="charity-stats">
                            <span>Balance: ${formatPrice(charity.balance)}</span>
                            <span>Joined: ${formatDate(charity.created_at)}</span>
                        </div>
                        <div class="charity-actions">
                            <button onclick="pauseCharity('${charity.id}')" class="btn-warning">
                                Pause
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';

            container.innerHTML = html;
        }

        // Load recent activity
        async function loadRecentActivity() {
            try {
                const { data: items, error } = await supabase
                    .from('items')
                    .select('*, charities(name)')
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (error) throw error;

                displayRecentActivity(items || []);

            } catch (err) {
                console.error('Error loading activity:', err);
            }
        }

        // Display recent activity
        function displayRecentActivity(items) {
            const container = document.getElementById('recentActivity');

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="no-items">
                        <p>No recent activity</p>
                    </div>
                `;
                return;
            }

            let html = '';
            items.forEach(item => {
                html += `
                    <div class="activity-item">
                        <div class="activity-icon">üì¶</div>
                        <div class="activity-details">
                            <p><strong>${item.charities?.name}</strong> added item <strong>${item.item_code}</strong></p>
                            <p class="activity-meta">Price: ${formatPrice(item.price)} ‚Ä¢ ${formatDate(item.created_at)}</p>
                        </div>
                        <div class="activity-status">
                            <span class="status-${item.status}">${item.status}</span>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Admin actions
        async function approveCharity(charityId) {
            try {
                showLoading('Approving charity...');

                const { error } = await supabase
                    .from('charities')
                    .update({
                        status: 'active',
                        approved_at: new Date().toISOString()
                    })
                    .eq('id', charityId);

                if (error) throw error;

                showSuccess('Charity approved successfully!');
                await loadAdminDashboard();

            } catch (err) {
                console.error('Approval error:', err);
                showError('Failed to approve charity: ' + err.message);
                hideLoading();
            }
        }

        async function rejectCharity(charityId) {
            try {
                if (!confirm('Are you sure you want to reject this charity application?')) {
                    return;
                }

                showLoading('Rejecting application...');

                const { error } = await supabase
                    .from('charities')
                    .delete()
                    .eq('id', charityId);

                if (error) throw error;

                showSuccess('Application rejected and removed');
                await loadAdminDashboard();

            } catch (err) {
                console.error('Rejection error:', err);
                showError('Failed to reject application: ' + err.message);
                hideLoading();
            }
        }

        async function pauseCharity(charityId) {
            try {
                showLoading('Pausing charity...');

                const { error } = await supabase
                    .from('charities')
                    .update({ status: 'paused' })
                    .eq('id', charityId);

                if (error) throw error;

                showSuccess('Charity paused');
                await loadAdminDashboard();

            } catch (err) {
                console.error('Pause error:', err);
                showError('Failed to pause charity: ' + err.message);
                hideLoading();
            }
        }

        async function refreshApplications() {
            await loadAdminDashboard();
        }

        // Initialize admin dashboard
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Admin dashboard loaded');
            
            // Simple admin check - in production, implement proper authentication
            const adminAccess = prompt('Admin Password:');
            if (adminAccess !== 'admin123') {
                alert('Access denied');
                window.location.href = '../index.html';
                return;
            }

            loadAdminDashboard();

            // Logout functionality
            document.getElementById('adminLogout').addEventListener('click', function() {
                window.location.href = '../index.html';
            });
        });
    </script>
</body>
</html>